<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß R√©solution du Probl√®me des Briques Fant√¥mes - WallSim3D</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .step {
            background: rgba(255,255,255,0.2);
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }
        .step h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .test-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .test-button:active {
            transform: translateY(0);
        }
        .test-button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .test-button.warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        .test-button.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .log {
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #FF9800; }
        .highlight { 
            background: rgba(255,255,0,0.2);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
        }
        .status.show {
            opacity: 1;
            transform: translateX(0);
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #FF9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß R√©solution du Probl√®me des Briques Fant√¥mes</h1>
        
        <div class="step">
            <h3>üìã √âtape 1: Diagnostic Initial</h3>
            <p>Identifiez les √©l√©ments fant√¥mes pr√©sents dans la sc√®ne.</p>
            <button class="test-button info" onclick="diagnosticComplet()">üîç Diagnostic Complet</button>
            <button class="test-button" onclick="rechercherFantomes()">üëª Rechercher Fant√¥mes</button>
        </div>

        <div class="step">
            <h3>üö´ √âtape 2: Masquage des Fant√¥mes</h3>
            <p>Masquez temporairement tous les √©l√©ments fant√¥mes d√©tect√©s.</p>
            <button class="test-button warning" onclick="masquerTousFantomes()">üö´ Masquer Tous les Fant√¥mes</button>
            <button class="test-button info" onclick="masquerSpecifique()">üéØ Masquage Sp√©cifique</button>
        </div>

        <div class="step">
            <h3>üìÑ √âtape 3: Test d'Export PDF</h3>
            <p>Testez l'export PDF pour v√©rifier que les fant√¥mes ne s'exportent plus.</p>
            <button class="test-button" onclick="testerExportPDF()">üìÑ Tester Export PDF</button>
            <button class="test-button info" onclick="simulerExport()">üî¨ Simuler Export</button>
        </div>

        <div class="step">
            <h3>üîÑ √âtape 4: Restauration</h3>
            <p>Restaurez les √©l√©ments fant√¥mes pour continuer le travail normal.</p>
            <button class="test-button warning" onclick="restaurerFantomes()">üîÑ Restaurer Fant√¥mes</button>
            <button class="test-button danger" onclick="reinitialiserTout()">üîÑ R√©initialiser Tout</button>
        </div>

        <div class="step">
            <h3>‚úÖ √âtape 5: Validation</h3>
            <p>V√©rifiez que la solution fonctionne correctement.</p>
            <button class="test-button" onclick="validationComplete()">‚úÖ Validation Compl√®te</button>
            <button class="test-button info" onclick="rapportFinal()">üìä Rapport Final</button>
        </div>

        <div id="log" class="log">Cliquez sur "Diagnostic Complet" pour commencer...\n</div>
    </div>

    <div id="status" class="status"></div>

    <script>
        let testResults = {
            diagnostics: [],
            maskedElements: [],
            exportTests: [],
            recommendations: []
        };

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type} show`;
            
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 3000);
        }

        function diagnosticComplet() {
            log('=== DIAGNOSTIC COMPLET DES √âL√âMENTS FANT√îMES ===', 'info');
            showStatus('Diagnostic en cours...', 'info');
            
            const results = {
                wallsim: !!window.WallSim3D,
                sceneManager: !!window.SceneManager,
                constructionTools: !!window.ConstructionTools,
                presentationManager: !!window.presentationManager,
                elements: []
            };
            
            // V√©rifications de base
            Object.entries(results).forEach(([key, value]) => {
                if (key !== 'elements') {
                    log(`${value ? '‚úÖ' : '‚ùå'} ${key}: ${value}`, value ? 'success' : 'error');
                }
            });
            
            if (!results.presentationManager) {
                log('‚ùå PresentationManager non disponible - Impossible de continuer', 'error');
                showStatus('Erreur: PresentationManager manquant', 'error');
                return;
            }
            
            // Lancer le diagnostic int√©gr√©
            try {
                const diagnostic = window.presentationManager.diagnoseAndMaskGhosts();
                testResults.diagnostics.push(diagnostic);
                
                log(`‚úÖ Diagnostic termin√©: ${diagnostic.totalMasked} √©l√©ments fant√¥mes masqu√©s`, 'success');
                showStatus(`${diagnostic.totalMasked} fant√¥mes masqu√©s`, 'warning');
                
                if (diagnostic.totalMasked > 0) {
                    log('‚ö†Ô∏è Des √©l√©ments fant√¥mes ont √©t√© d√©tect√©s et masqu√©s', 'warning');
                    log('üí° Passez √† l\'√©tape suivante: Test d\'Export PDF', 'info');
                } else {
                    log('‚úÖ Aucun √©l√©ment fant√¥me d√©tect√© - L\'export devrait √™tre propre', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erreur lors du diagnostic: ${error.message}`, 'error');
                showStatus('Erreur de diagnostic', 'error');
            }
        }

        function rechercherFantomes() {
            log('=== RECHERCHE SP√âCIALIS√âE DES FANT√îMES ===', 'info');
            
            if (!window.SceneManager || !window.SceneManager.scene) {
                log('‚ùå Scene non disponible', 'error');
                return;
            }
            
            let fantomes = [];
            let totalMeshes = 0;
            
            window.SceneManager.scene.traverse((object) => {
                if (object.isMesh) {
                    totalMeshes++;
                    
                    let isFantome = false;
                    let raisons = [];
                    
                    // Test opacit√©
                    if (object.material && object.material.opacity < 1.0) {
                        isFantome = true;
                        raisons.push(`opacity=${object.material.opacity.toFixed(2)}`);
                    }
                    
                    // Test userData
                    if (object.userData) {
                        const clesFantomes = ['ghost', 'preview', 'phantom', 'cursor', 'temp'];
                        const clesTrouvees = clesFantomes.filter(cle => 
                            Object.keys(object.userData).some(k => k.toLowerCase().includes(cle))
                        );
                        
                        if (clesTrouvees.length > 0) {
                            isFantome = true;
                            raisons.push(`userData: ${clesTrouvees.join(', ')}`);
                        }
                    }
                    
                    // Test nom
                    if (object.name && ['ghost', 'preview', 'phantom', 'temp', 'cursor'].some(mot => 
                        object.name.toLowerCase().includes(mot))) {
                        isFantome = true;
                        raisons.push(`nom: "${object.name}"`);
                    }
                    
                    if (isFantome) {
                        fantomes.push({
                            object: object,
                            nom: object.name || 'sans nom',
                            visible: object.visible,
                            raisons: raisons,
                            position: `(${object.position.x.toFixed(1)}, ${object.position.y.toFixed(1)}, ${object.position.z.toFixed(1)})`
                        });
                    }
                }
            });
            
            log(`üìä R√©sultat: ${fantomes.length} fant√¥mes trouv√©s sur ${totalMeshes} meshes`, 'info');
            
            fantomes.forEach((fantome, index) => {
                log(`${fantome.visible ? 'üëª' : 'üö´'} ${fantome.nom}: ${fantome.raisons.join(' | ')} @ ${fantome.position}`, 
                    fantome.visible ? 'warning' : 'success');
            });
            
            showStatus(`${fantomes.length} fant√¥mes trouv√©s`, 'info');
        }

        function masquerTousFantomes() {
            log('=== MASQUAGE DE TOUS LES FANT√îMES ===', 'warning');
            
            try {
                if (window.presentationManager.diagnoseAndMaskGhosts) {
                    const result = window.presentationManager.diagnoseAndMaskGhosts();
                    testResults.maskedElements.push(result);
                    log(`‚úÖ ${result.totalMasked} √©l√©ments masqu√©s avec succ√®s`, 'success');
                    showStatus('Fant√¥mes masqu√©s avec succ√®s', 'success');
                } else {
                    log('‚ùå Fonction de masquage non disponible', 'error');
                    showStatus('Erreur: Fonction manquante', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur lors du masquage: ${error.message}`, 'error');
                showStatus('Erreur de masquage', 'error');
            }
        }

        function masquerSpecifique() {
            log('=== MASQUAGE SP√âCIFIQUE ===', 'info');
            
            // Masquage cibl√© des √©l√©ments connus
            let masked = 0;
            
            if (window.ConstructionTools) {
                const elements = ['ghostElement', 'ghostBrick', 'previewElement', 'currentGhost'];
                elements.forEach(elemName => {
                    const elem = window.ConstructionTools[elemName];
                    if (elem) {
                        const mesh = elem.mesh || elem;
                        if (mesh && mesh.visible) {
                            mesh.visible = false;
                            masked++;
                            log(`üö´ Masqu√©: ConstructionTools.${elemName}`, 'warning');
                        }
                    }
                });
            }
            
            log(`‚úÖ ${masked} √©l√©ments sp√©cifiques masqu√©s`, 'success');
            showStatus(`${masked} √©l√©ments masqu√©s`, 'success');
        }

        function testerExportPDF() {
            log('=== TEST D\'EXPORT PDF ===', 'info');
            
            if (!window.presentationManager || !window.presentationManager.generatePDF) {
                log('‚ùå Fonction d\'export PDF non disponible', 'error');
                showStatus('Erreur: Export PDF indisponible', 'error');
                return;
            }
            
            log('üîÑ Lancement de l\'export PDF...', 'info');
            log('üí° V√©rifiez si les briques fant√¥mes apparaissent dans le PDF g√©n√©r√©', 'warning');
            
            try {
                // D√©clencher l'export PDF
                window.presentationManager.generatePDF();
                log('‚úÖ Export PDF lanc√© - V√©rifiez le r√©sultat', 'success');
                showStatus('Export PDF en cours...', 'info');
                
                testResults.exportTests.push({
                    timestamp: new Date().toISOString(),
                    status: 'launched'
                });
                
            } catch (error) {
                log(`‚ùå Erreur lors de l\'export: ${error.message}`, 'error');
                showStatus('Erreur d\'export', 'error');
            }
        }

        function simulerExport() {
            log('=== SIMULATION D\'EXPORT ===', 'info');
            
            // Simuler les √©tapes de l'export sans g√©n√©rer le PDF
            log('üîÑ Simulation du processus d\'export...', 'info');
            
            // Test du masquage des aides visuelles
            if (window.presentationManager && window.presentationManager.disableVisualAidsForExport) {
                try {
                    log('üìã Test du masquage des aides visuelles...', 'info');
                    window.presentationManager.disableVisualAidsForExport();
                    log('‚úÖ Aides visuelles masqu√©es', 'success');
                    
                    setTimeout(() => {
                        if (window.presentationManager.restoreVisualAidsAfterExport) {
                            window.presentationManager.restoreVisualAidsAfterExport();
                            log('üîÑ Aides visuelles restaur√©es', 'info');
                        }
                    }, 2000);
                    
                } catch (error) {
                    log(`‚ùå Erreur simulation: ${error.message}`, 'error');
                }
            }
            
            showStatus('Simulation termin√©e', 'success');
        }

        function restaurerFantomes() {
            log('=== RESTAURATION DES FANT√îMES ===', 'warning');
            
            try {
                if (window.presentationManager.restoreGhosts) {
                    window.presentationManager.restoreGhosts();
                    log('‚úÖ √âl√©ments fant√¥mes restaur√©s', 'success');
                    showStatus('Fant√¥mes restaur√©s', 'success');
                } else {
                    log('‚ö†Ô∏è Fonction de restauration non disponible', 'warning');
                    log('üí° Les fant√¥mes se restaureront automatiquement en mode normal', 'info');
                    showStatus('Restauration automatique', 'info');
                }
            } catch (error) {
                log(`‚ùå Erreur lors de la restauration: ${error.message}`, 'error');
                showStatus('Erreur de restauration', 'error');
            }
        }

        function reinitialiserTout() {
            log('=== R√âINITIALISATION COMPL√àTE ===', 'danger');
            
            // Recharger la page pour remettre √† z√©ro
            if (confirm('‚ö†Ô∏è Cela va recharger la page. Continuer ?')) {
                window.location.reload();
            }
        }

        function validationComplete() {
            log('=== VALIDATION COMPL√àTE ===', 'info');
            
            const validation = {
                masquageOK: testResults.maskedElements.length > 0,
                exportTeste: testResults.exportTests.length > 0,
                erreurs: 0
            };
            
            log('üìã R√©sum√© de la validation:', 'info');
            log(`‚úÖ Masquage test√©: ${validation.masquageOK ? 'OUI' : 'NON'}`, validation.masquageOK ? 'success' : 'warning');
            log(`‚úÖ Export test√©: ${validation.exportTeste ? 'OUI' : 'NON'}`, validation.exportTeste ? 'success' : 'warning');
            
            if (validation.masquageOK && validation.exportTeste) {
                log('üéâ VALIDATION R√âUSSIE - Le probl√®me devrait √™tre r√©solu !', 'success');
                showStatus('Validation r√©ussie !', 'success');
            } else {
                log('‚ö†Ô∏è VALIDATION INCOMPL√àTE - Effectuez tous les tests', 'warning');
                showStatus('Tests incomplets', 'warning');
            }
        }

        function rapportFinal() {
            log('=== RAPPORT FINAL ===', 'info');
            
            const rapport = {
                timestamp: new Date().toLocaleString(),
                diagnostics: testResults.diagnostics.length,
                elementsMasques: testResults.maskedElements.reduce((sum, r) => sum + r.totalMasked, 0),
                exportsTests: testResults.exportTests.length
            };
            
            log('üìä STATISTIQUES FINALES:', 'info');
            log(`üîç Diagnostics effectu√©s: ${rapport.diagnostics}`, 'info');
            log(`üö´ √âl√©ments fant√¥mes masqu√©s: ${rapport.elementsMasques}`, 'info');
            log(`üìÑ Tests d'export: ${rapport.exportsTests}`, 'info');
            log(`‚è∞ Horodatage: ${rapport.timestamp}`, 'info');
            
            log('', 'info');
            log('üí° RECOMMANDATIONS FINALES:', 'success');
            log('1. ‚úÖ Le syst√®me de masquage renforc√© a √©t√© appliqu√©', 'success');
            log('2. üìÑ Testez maintenant un export PDF r√©el pour v√©rifier', 'success');
            log('3. üîÑ Les fant√¥mes se restaureront automatiquement apr√®s l\'export', 'success');
            log('4. üõ†Ô∏è En cas de probl√®me persistant, contactez le support technique', 'info');
            
            showStatus('Rapport g√©n√©r√©', 'success');
        }

        // Auto-d√©marrage
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.SceneManager && window.presentationManager) {
                    log('üöÄ WallSim3D d√©tect√© ! Pr√™t pour la r√©solution des fant√¥mes.', 'success');
                    showStatus('Syst√®me pr√™t', 'success');
                } else {
                    log('‚ö†Ô∏è WallSim3D non d√©tect√©. Chargez un projet d\'abord.', 'warning');
                    showStatus('WallSim3D manquant', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>